#!/usr/bin/env php
<?php

require __DIR__ . '/../vendor/autoload.php';
require __DIR__ . '/../bootstrap.php';

use Symfony\Component\Console\Application;
use Symfony\Component\Console\Input\InputOption;
use Symfony\Component\Console\Input\ArgvInput;

// Analysis commands
use QSAssetManager\Command\Exploration\Analysis\RenameAnalysisCommand;
use QSAssetManager\Command\Exploration\Analysis\RemoveBrokenAnalysisDataSetsCommand;
use QSAssetManager\Command\Exploration\Analysis\DeployAnalysisCommand;

// Dashboard commands
use QSAssetManager\Command\Exploration\Dashboard\RenameDashboardCommand;
use QSAssetManager\Command\Exploration\Dashboard\RemoveBrokenDashboardDataSetsCommand;
use QSAssetManager\Command\Exploration\Dashboard\DeployDashboardCommand;

// Dataset commands
use QSAssetManager\Command\Dataset\DeployDatasetCommand;
use QSAssetManager\Command\Dataset\RenameDatasetCommand;

// Reporting and export commands
use QSAssetManager\Command\Export\ExportAssetsCommand;
use QSAssetManager\Command\Reporting\ExportAssetReportCommand;
use QSAssetManager\Command\Reporting\ExportDashboardViewCountsCommand;
use QSAssetManager\Command\Reporting\ExportUserReportCommand;
use QSAssetManager\Command\Reporting\ExportIngestionDetailsCommand;  // <— New

// Tagging and user management
use QSAssetManager\Command\Tagging\ScanAssetsCommand;
use QSAssetManager\Command\User\DeleteInactiveUsersCommand;

// Permissions commands
use QSAssetManager\Command\Permissions\AddPrincipalPermissionsCommand;

// Load global configuration
$config = require PROJECT_ROOT . '/config/global.php';

$application = new Application('QSAssetManager', '1.0.0');

// Add global profile option
$application->getDefinition()->addOption(
    new InputOption('profile', 'p', InputOption::VALUE_OPTIONAL, 'AWS profile to use')
);

// Check for profile option and set AWS_PROFILE environment variable
$input = new ArgvInput();
if ($input->hasParameterOption(['--profile', '-p'])) {
    $profile = $input->getParameterOption(['--profile', '-p']);
    if ($profile) {
        putenv("AWS_PROFILE=$profile");
        $_ENV['AWS_PROFILE'] = $profile;
    }
}

// Register commands
// Analysis
$application->add(new RenameAnalysisCommand());
$application->add(new RemoveBrokenAnalysisDataSetsCommand());
$application->add(new DeployAnalysisCommand());

// Dashboard
$application->add(new RenameDashboardCommand());
$application->add(new RemoveBrokenDashboardDataSetsCommand());
$application->add(new DeployDashboardCommand());

// Dataset
$application->add(new DeployDatasetCommand());
$application->add(new RenameDatasetCommand());

// Reporting & Exports
$application->add(new ExportAssetsCommand());
$application->add(new ExportAssetReportCommand());
$application->add(new ExportDashboardViewCountsCommand());
$application->add(new ExportUserReportCommand());
$application->add(new ExportIngestionDetailsCommand());  // <— New

// Misc
$application->add(new ScanAssetsCommand());
$application->add(new DeleteInactiveUsersCommand());

// Permissions
$application->add(new AddPrincipalPermissionsCommand());

$application->run();
